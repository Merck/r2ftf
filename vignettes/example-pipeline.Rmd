---
title: "RTF Examples for Tables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RTF Examples for Tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all() # need to be updated after the package mature

library(dplyr)
library(tidyr)
library(emmeans)
```

Define some utility functions
```{r}
#' Format Model Estimator
#'
#' The function assume 1 or 2 column.
#'   If there is only 1 column, only represent mean
#'   If there are 2 column, represent mean (sd) or mean(se)
#' Decimals will understand the number will be formated as x.x(x.xx)
#' @noRd
fmt_est <- function(data, columns = c("mean", "sd"), decimals = c(1, 2)) {
  .mean <- formatC(data[[columns[[1]]]], digits = decimals[1], format = "f", flag = "0")
  if (length(columns) > 1) {
    .sd <- formatC(data[[columns[[2]]]], digits = decimals[2], format = "f", flag = "0")
    paste0(.mean, " (", .sd, ")")
  } else {
    .mean
  }
}

#' Format Confidence Interval
#' @noRd
fmt_ci <- function(data, columns = c("lower.CL", "upper.CL"), decimals = 2) {
  .lower <- formatC(data[[columns[[1]]]], digits = decimals, format = "f", flag = "0")
  .upper <- formatC(data[[columns[[2]]]], digits = decimals, format = "f", flag = "0")
  paste0("(", .lower, ", ", .upper, ")")
}

#' Format P-Value
#' @noRd
fmt_pval <- function(data, columns = "p.value", decimals = 3) {
  scale <- 10^(-1 * decimals)
  p_scale <- paste0("<", scale)
  if_else(data[[columns[[1]]]] < scale, p_scale,
    formatC(data[[columns[[1]]]], digits = decimals, format = "f", flag = "0")
  )
}
```

# Examples
## Example 1: ANCOVA analysis for HOMA data


* The data is available at [https://missingdata.lshtm.ac.uk/dia-working-group/example-data-sets/](https://missingdata.lshtm.ac.uk/dia-working-group/example-data-sets/)

* For example, we want to summary the analysis results using ANCOVA model 

```{r}
data("HAMD17")
ana_week <- 8 # Analysis Week

HAMD17_lmfit <- HAMD17 %>%
  filter(week == ana_week) %>%
  lm(change ~ basval + TRT, data = .)
```

### Raw summary
```{r}
t11 <- HAMD17 %>%
  filter(week == ana_week) %>%
  group_by(TRT) %>%
  summarise(
    N = n(),
    mean_bl = mean(basval),
    sd_bl = sd(basval),
    mean = mean(change),
    sd = sd(change)
  )
```

### LS mean 
```{r}
t12 <- emmeans(HAMD17_lmfit, "TRT")
t1 <- merge(t11, t12) %>%
  mutate(emmean_sd = SE * sqrt(df)) %>%
  mutate(
    Trt = c("Study Drug", "Placebo"),
    N1 = N,
    Mean1 = fmt_est(., c("mean_bl", "sd_bl")),
    N2 = N,
    Mean2 = fmt_est(., c("mean", "sd")),
    N3 = N,
    Mean3 = fmt_est(., c("emmean", "emmean_sd")),
    CI = paste(fmt_est(., "emmean"), fmt_ci(., c("lower.CL", "upper.CL")))
  ) %>%
  select(Trt:CI)
```

### Treatment Comparison
```{r}
t2 <- data.frame(pairs(t12))

t2 <- t2 %>%
  mutate(
    lower = estimate - 1.96 * SE,
    upper = estimate + 1.96 * SE
  ) %>%
  mutate(
    comp = "Study Drug vs. Placebo",
    mean = paste(fmt_est(., "estimate"), fmt_ci(., c("lower", "upper"))),
    p = fmt_pval(., "p.value")
  ) %>%
  select(comp:p)
```

### RMSE
```{r}
t3 <- data.frame(rmse = paste0(
  "Root Mean Squared Error of Change = ",
  formatC(sd(HAMD17_lmfit$residuals), digits = 2, format = "f", flag = "0")
))
```

The purpose of this exercise is to create a table as in `rtf_example1.rtf` by using the three datasets `t1`, `t2` and `t3`

```{r}
t1
```

```{r}
t2
```

```{r}
t3
```


For multiple tables like the efficacy example, we have a flow in the following to print an rtf table
```{r}

tbl_1 <- t1 %>%
  rtf_title(
    title = "ANCOVA of Change from Baseline at Week 8",
    subtitle = c(
      "Missing Data Approach",
      "Analysis Population"
    )
  ) %>%
  rtf_colheader(
    colheader = " | Baseline | Week 20 | Change from Baseline",
    col_rel_width = c(3, 4, 4, 9)
  ) %>%
  rtf_colheader(colheader = "Treatment | N | Mean (SD) | N | Mean (SD) | N | Mean (SD) | LS Mean (95% CI){^a}", 
                col_rel_width = c(3, 1, 3, 1, 3, 1, 3, 5)) %>%
  rtf_body(
    col_rel_width = c(3, 1, 3, 1, 3, 1, 3, 5),
    text_justification = c("l", rep("c", 7)),
    last_row = FALSE
  ) %>%
  rtf_footnote(
    footnote = c("{^a}Based on an ANCOVA model.",
                 "ANCOVA = Analysis of Covariance, CI = Confidence Interval, LS = Least Squares, SD = Standard Deviation")
  )


tbl_2 <- t2 %>%
  rtf_colheader(
    colheader = "Pairwise Comparison | Difference in LS Mean (95% CI){^a} | p-Value",
    text_justification = c("l", "c", "c"),
    col_rel_width = c(8, 7, 5)
  ) %>%
  rtf_body(
    col_rel_width = c(8, 7, 5),
    text_justification = c("l", "c", "c"),
    last_row = FALSE
  )


tbl_3 <- t3 %>%
  rtf_body(
    colheader = FALSE,
    col_rel_width = c(1),
    border_color_left = "red",
    text_justification = "l"
  ) %>%
  rtf_source(
    source = "Source: [study999: adam-adeff]"
  )


tbl <- list(tbl_1, tbl_2, tbl_3)
```

```{r}
tbl %>%
  rtf_encode() %>%
  write_rtf("rtf/efficacy_example.rtf")
```

```{r, out.width = "100%", out.height = "400px", echo = FALSE, fig.align = "center"}
knitr::include_graphics("pdf/efficacy_example.pdf")
```


## Example 2: a simplified adverse events summary table


# get raw summary 
```{r}
# Step 1: Get raw summary
data(adae)
ae_t1 <- adae %>%
  group_by(TRTA) %>%
  mutate(n_subj = n_distinct(USUBJID)) %>%
  group_by(TRTA, AEDECOD) %>%
  summarise(
    n_ae = n_distinct(USUBJID),
    pct = round(n_ae / unique(n_subj) * 100, 2)
  ) %>%
  dplyr::filter(n_ae > 4) %>% # only show AE terms with at least 10 subjects in one treatment group.
  gather(key = "var", value = "value", n_ae, pct) %>%
  unite(temp, TRTA, var) %>%
  spread(temp, value, fill = 0)
ae_t1
```

# write to an rtf table 
```{r}
ae_tbl <- ae_t1 %>%
  rtf_title(
    "Analysis of Subjects With Specific Adverse Events",
    c(
      "(Incidence > 10 Subjects in One or More Treatment Groups)",
      "ASaT"
    )
  ) %>%
  rtf_colheader(" | Placebo | Drug High Dose | Drug Low Dose",
    col_rel_width = c(4, rep(2, 3))
  ) %>%
  rtf_colheader(" | n | (%) | n | (%) | n | (%)",
    col_rel_width = c(4, rep(1, 6)),
    border_top = c("", rep("single", 6)),
    border_left = c("single", rep(c("single", ""), 3))
  ) %>%
  rtf_body(
    col_rel_width = c(4, rep(1, 6)),
    text_justification = c("l", rep("c", 6)),
    border_left = c("single", rep(c("single", ""), 3))
  ) %>%
  rtf_footnote(c("{^\\dagger}This is footnote 1", "This is footnote 2"),
  ) %>%
  rtf_source("Source: xxx"
  )


ae_tbl %>%
  rtf_encode() %>%
  write_rtf("rtf/ae_example.rtf")
```

# Example 3: adverse events example page_by option

# write to an rtf table 
```{r}
ae_tbl <- ae_t1 %>%
  rtf_page(nrow = 10) %>%
  rtf_title(
    "Analysis of Subjects With Specific Adverse Events",
    c(
      "(Incidence > 10 Subjects in One or More Treatment Groups)",
      "ASaT"
    )
  ) %>%
  rtf_colheader(" | Placebo | Drug High Dose | Drug Low Dose",
    col_rel_width = c(4, rep(2, 3))
  ) %>%
  rtf_colheader(" | n | (%) | n | (%) | n | (%)",
    col_rel_width = c(4, rep(1, 6)),
    border_top = c("", rep("single", 6)),
    border_left = c("single", rep(c("single", ""), 3))
  ) %>%
  rtf_body(
    col_rel_width = c(4, rep(1, 6)),
    text_justification = c("l", rep("c", 6)),
    border_left = c("single", rep(c("single", ""), 3))
  ) %>%
  rtf_footnote("This is a footnote") %>%
  rtf_source("Source: xxx")


ae_tbl %>%
  rtf_encode() %>%
  write_rtf("rtf/ae_example_page_num_10.rtf")
```


# Example 4: group_by feature

```{r}
data(iris)

iris <- cbind(iris, new_cat = rep(c("A", "B", "C", "D", "E"), 30))

iris_tbl <- iris %>% arrange(Species, new_cat) %>% 
  rtf_page(nrow = 30) %>%
  rtf_title("IRIS DATA") %>%
  rtf_colheader("Sepal Length | Sepal Width | Petal Length | PetalWidth",
  ) %>%
  rtf_body(
    page_by = c("Species", "new_cat"),
    border_top = c(rep("",4),c("single", "single")),
    border_bottom = c(rep("", 4), c("single", "single")),
    text_justification = c(rep("c", 4), c("l", "l")),
    new_page = TRUE
  ) %>%
  rtf_footnote("This is a footnote") %>%
  rtf_source("Source: xxx")

iris_tbl %>%
  rtf_encode() %>%
  write_rtf("rtf/iris_example.rtf")
```

## Example 5: A very simple example
```{r}
data(iris)

iris_tbl <- iris[1:20, ] %>% rtf_body()

iris_tbl %>%
  rtf_encode() %>%
  write_rtf("rtf/iris_very_simple.rtf")
```

## Example 6: A  simple example
```{r}
data(iris)

iris_tbl <- iris[1:20, ] %>%
  rtf_title("IRIS DATA") %>%
  rtf_colheader("Sepal Length | Sepal Width | Petal Length | PetalWidth | Species"
  ) %>%
  rtf_body() %>%
  rtf_footnote("This is a footnote") %>%
  rtf_source("Source: xxx")

iris_tbl %>%
  rtf_encode() %>%
  write_rtf("rtf/iris_simple.rtf")
```

## Example 7: baseline characteristics example feature
```{r}
bs_count <- function(data, grp, var,
                     var_label = var,
                     decimal = 1,
                     total = TRUE) {
  data <- data %>% rename(grp = !!grp, var = !!var)
  coding <- levels(factor(data$grp))
  data <- data %>% mutate(grp = as.numeric(factor(grp)))

  # res <- data %>% count(grp, var, .drop = FALSE)
  res <- with(data, table(var, grp)) %>%
    as.data.frame() %>%
    mutate(grp = as.numeric(grp))

  if (total) {
    res_tot <- with(data, table(var)) %>%
      as.data.frame() %>%
      mutate(grp = 9999)
    res <- bind_rows(res, res_tot)
  }

  res <- res %>% rename(n = Freq)

  res <- res %>% mutate(pct = formatC(n / sum(n) * 100, digits = decimal, format = "f", flag = "0"))

  res <- res %>%
    gather("key", "value", n, pct) %>%
    unite(keys, grp, key) %>%
    spread(keys, value) %>%
    mutate(var_label = var_label) %>%
    mutate(var = as.character(var))

  names(res) <- gsub("_n", "", names(res), fixed = TRUE)
  attr(res, "coding") <- coding

  res
}

bs_continous <- function(data, grp, var,
                         var_label = var,
                         decimal = 1,
                         total = TRUE,
                         blank_row = FALSE) {
  data <- data %>% rename(grp = !!grp, var = !!var)
  coding <- levels(factor(data$grp))
  data <- data %>% mutate(grp = as.numeric(factor(grp)))

  res <- data %>%
    select(grp, var) %>%
    na.omit() %>%
    group_by(grp) %>%
    summarise(
      `Subjects with data` = n(),
      Mean = formatC(mean(var), digits = decimal, format = "f", flag = "0"),
      SD = formatC(sd(var), digits = decimal, format = "f", flag = "0"),
      Median = formatC(median(var), digits = decimal, format = "f", flag = "0"),
      Range = paste(range(var), collapse = " to ")
    )

  if (total) {
    res_tot <- data %>%
      select(grp, var) %>%
      na.omit() %>%
      summarise(
        `Subjects with data` = n(),
        Mean = formatC(mean(var), digits = decimal, format = "f", flag = "0"),
        SD = formatC(sd(var), digits = decimal, format = "f", flag = "0"),
        Median = formatC(median(var), digits = decimal, format = "f", flag = "0"),
        Range = paste(range(var), collapse = " to ")
      ) %>%
      mutate(grp = 9999)
    res <- bind_rows(res, res_tot)
  }


  res <- res %>%
    gather("key", "value", -grp) %>%
    mutate(key = factor(key, levels = c("Subjects with data", "Mean", "SD", "Median", "Range"))) %>%
    spread(grp, value) %>%
    mutate(var_label = var_label) %>%
    mutate(key = as.character(key)) %>%
    rename(var = key)

  if (blank_row) {
    res <- bind_rows(tibble(var_label = var_label), res)
  }

  res
}

# The code above define two utility function for baseline characterstic tables.



# Analaysis Set
data(adsl)
ana <- adsl %>% subset(ITTFL == "Y")
ana <- ana %>% mutate(
  RACE = factor(
    RACE,
    c("WHITE", "BLACK OR AFRICAN AMERICAN", "AMERICAN INDIAN OR ALASKA NATIVE"),
    c("White", "Black", "Other")
  ),
  SEX = factor(SEX, c("F", "M"), c("Female", "Male"))
)

# Build Data for r2rtf
bs_tb <- bind_rows(
  bs_count(ana, "TRT01AN", "SEX", "Gender"),
  bs_count(ana, "TRT01AN", "AGEGR1", "Age (Years)"),
  bs_continous(ana, "TRT01AN", "AGE", "Age (Years)", blank_row = TRUE),
  bs_count(ana, "TRT01AN", "RACE", "Race")
)

bs_tb[is.na(bs_tb)] <- ""
```


```{r}
bs_rtf <- bs_tb %>%
  rtf_page(width = 9.5) %>%
  rtf_title("Demographic and Anthropometric Characteristics", "ITT Subjects") %>%
  rtf_colheader(" | Placebo | Drug Low Dose | Drug High Dose | Total | label",
    col_rel_width = c(3, rep(2, 4), 3)
  ) %>%
  rtf_colheader(" | n | (%) | n | (%) | n | (%) | n | (%) | label",
    col_rel_width = c(3, rep(c(1.2, 0.8), 4), 3),
    border_top = c("", rep("single", 9)),
    border_left = c("single", rep(c("single", ""), 4), "single")
  ) %>%
  rtf_body(
    col_rel_width = c(3, rep(c(1.2, 0.8), 4), 3),
    text_justification = c("l", rep("d", 8), "c"),
    border_left = c("single", rep(c("single", ""), 4), "single")
  ) %>%
  rtf_footnote("This is a footnote") %>%
  rtf_source("Source: xxx")


# Output

bs_rtf %>%
  rtf_encode() %>%
  write_rtf("rtf/bs_example.rtf")
```


## Example 8: baseline characteristics example page_by feature

```{r}
## r2rtf rtf table createion pipeline
bs_rtf <- bs_tb %>%
  rtf_title("Demographic and Anthropometric Characteristics", "ITT Subjects") %>%
  rtf_colheader(" | Placebo | Drug Low Dose | Drug High Dose | Total",
    col_rel_width = c(3, rep(2, 4))
  ) %>%
  rtf_colheader(" | n | (%) | n | (%) | n | (%) | n | (%)",
    col_rel_width = c(3, rep(c(1.2, 0.8), 4)),
    border_top = c("", rep("single", 8)),
    border_left = c("single", rep(c("single", ""), 4))
  ) %>%
  rtf_body(
    page_by = "var_label", # this option show the label in one row.
    col_rel_width = c(3, rep(c(1.2, 0.8), 4), 1),
    text_justification = c("l", rep("d", 8), "l"),
    border_left = c("single", rep(c("single", ""), 4), "single"),
    border_top =  c(rep("", 9), "single"), 
    border_bottom = c(rep("", 9), "single")
  ) %>%
  rtf_footnote("This is a footnote") %>%
  rtf_source("Source: xxx")


# Output

bs_rtf %>%
  rtf_encode() %>%
  write_rtf("rtf/bs_pageby_example.rtf")
```
